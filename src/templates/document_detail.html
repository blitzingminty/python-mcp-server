{% extends "base.html" %}

{% block title %}{{ data.page_title }}{% endblock %}

{% block content %}

{# Display errors passed via query parameter at the top #}
{% if data.error %}
<p style="color: red; border: 1px solid red; padding: 10px; margin-bottom: 15px;">
    <strong>Error:</strong> {{ data.error }}
</p>
{% endif %}


{% if data.document %}
    <h1>Document: {{ data.document.name }}</h1>

    {# Action Buttons #}
    <div style="margin-bottom: 15px;">
        <a href="{{ request.url_for('ui_view_project', project_id=data.document.project_id) }}">Back to Project</a> |
        <a href="{{ request.url_for('ui_edit_document', doc_id=data.document.id) }}">Edit Metadata</a>  |
        <form method="post" action="{{ request.url_for('ui_delete_document', doc_id=data.document.id) }}" style="display: inline;"
        onsubmit="return confirm('Are you sure you want to delete document \'{{ data.document.name }}\'? This cannot be undone.');">
    <button type="submit" style="border: none; background: none; color: blue; text-decoration: underline; cursor: pointer; padding: 0;">Delete Document</button> {# Link-like button #}
  </form>
  </div>

    {# Basic Details #}
    <p><strong>ID:</strong> {{ data.document.id }}</p>
    <p><strong>Project ID:</strong> {{ data.document.project_id }}</p>
    <p><strong>Path:</strong> {{ data.document.path }}</p>
    <p><strong>Type:</strong> {{ data.document.type }}</p>
    <p><strong>Current Version:</strong> {{ data.document.version }}</p>
    <p><strong>Created:</strong> {{ data.document.created_at.strftime('%Y-%m-%d %H:%M:%S') if data.document.created_at else '-' }}</p>
    <p><strong>Updated:</strong> {{ data.document.updated_at.strftime('%Y-%m-%d %H:%M:%S') if data.document.updated_at else '-' }}</p>

    <hr>

    {# Document Content #}
    <h2>Content</h2>
    {# Display content safely. Use <pre> for plain text or consider markdown conversion if applicable #}
    <pre style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; max-height: 400px; overflow-y: auto;">{{ data.document.content }}</pre>

    <hr>

    {# --- MODIFIED Tags Section --- #}
    <h2>Tags</h2>
    {% if data.document.tags %}
        <ul style="list-style: none; padding-left: 0; margin-bottom: 10px;">
            {# Sort tags alphabetically for consistent display #}
            {% for tag in data.document.tags|sort(attribute='name') %}
                <li style="display: inline-block; margin-right: 5px; margin-bottom: 5px; background-color: #e9ecef; padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">
                    {{ tag.name }}
                    {# --- Actual Remove Tag Form --- #}
                    <form method="post" action="{{ request.url_for('ui_remove_tag_from_document', doc_id=data.document.id) }}" style="display: inline; margin-left: 4px;">
                        {# Pass tag name via hidden input #}
                        <input type="hidden" name="tag_name" value="{{ tag.name }}">
                        <button type="submit" title="Remove tag '{{ tag.name }}'" style="border: none; background: none; color: red; cursor: pointer; padding: 0; font-weight: bold;">&times;</button>
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No tags associated with this document.</p>
    {% endif %}

    {# --- Actual Add Tag Form --- #}
    <form method="post" action="{{ request.url_for('ui_add_tag_to_document', doc_id=data.document.id) }}" style="margin-top: 10px;">
        <label for="tag_name">Add Tag:</label>
        <input type="text" id="tag_name" name="tag_name" placeholder="New tag name" required style="margin-left: 5px; padding: 4px;">
        <button type="submit" style="padding: 4px 8px;">Add Tag</button>
    </form>
    {# --- END MODIFIED Tags Section --- #}


    <hr>

    {# Versions Section #}
    <h2>Versions</h2>
    {% if data.document.versions %}
        <table border="1" style="border-collapse: collapse; width: 100%;">
            <thead>
                <tr>
                    <th>Version ID</th>
                    <th>Version String</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {# Versions are already sorted by ID descending in web_routes.py #}
                {% for version in data.document.versions %}
                <tr>
                    <td>{{ version.id }}</td>
                    <td>
                        {{ version.version }} {# Use version.version now #}
                        {% if version.version == data.document.version %}<strong style="color: green;"> (Current)</strong>{% endif %}
                    </td>
                    <td>{{ version.created_at.strftime('%Y-%m-%d %H:%M:%S') if version.created_at else '-' }}</td>
                    <td>
                        {# Placeholder link for viewing specific version content #}
                        <a href="#">View Content</a> {# Keep placeholder for Step 7 #}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No historical versions found for this document.</p>
    {% endif %}

{% else %}
    {# This part might not be reached if using HTTPException for not found #}
    <h1>Document Not Found</h1>
    <p>The requested document could not be found.</p>
    <p><a href="{{ request.url_for('ui_list_projects') }}">Back to Projects List</a></p>
{% endif %}

{% endblock %}
